<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управління товарами - iStore Admin</title>
    <link rel="stylesheet" href="admin-products.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Все ваши стили остаются без изменений */
        .users-section { display: none; }
        .users-section.active { display: block; }
        .users-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .users-table th, .users-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e1e1e1; }
        .users-table th { background: #f8f9fa; font-weight: bold; color: #333; }
        .user-status { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-active { background: #d4edda; color: #155724; }
        .status-blocked { background: #f8d7da; color: #721c24; }
        .status-admin { background: #cce7ff; color: #004085; }
        .user-actions { display: flex; gap: 5px; }
        .user-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s; }
        .user-btn.block { background: #e53935; color: white; }
        .user-btn.unblock { background: #4CAF50; color: white; }
        .user-btn.admin { background: #007aff; color: white; }
        .user-btn.history { background: #ffa000; color: white; }
        .user-btn.password { background: #9c27b0; color: white; }
        .user-btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .empty-users { text-align: center; padding: 40px 20px; color: #666; }
        .empty-users i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
        .admin-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .admin-tab { padding: 12px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; transition: all 0.3s; }
        .admin-tab.active { border-bottom-color: #007aff; color: #007aff; }

        /* Стилі для чату підтримки */
        .support-chat-section { display: none; }
        .support-chat-section.active { display: block; }
        .support-chat-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 600px; }
        .chat-users-list { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto; }
        .chat-user-item { padding: 15px 20px; border-bottom: 1px solid #e1e1e1; cursor: pointer; transition: all 0.3s; display: flex; justify-content: space-between; align-items: flex-start; }
        .chat-user-item:hover { background: #f8f9fa; }
        .chat-user-item.active { background: #007aff; color: white; }
        .chat-user-info { display: flex; flex-direction: column; flex: 1; }
        .chat-user-name { font-weight: bold; margin-bottom: 5px; }
        .chat-user-last-message { font-size: 12px; color: #666; opacity: 0.8; line-height: 1.3; }
        .chat-user-item.active .chat-user-last-message { color: white; }
        .chat-user-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .chat-user-time { font-size: 11px; color: #999; white-space: nowrap; }
        .chat-user-item.active .chat-user-time { color: white; }
        .unread-badge { background: #e53935; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
        .admin-chat-container { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 100%; }
        .admin-chat-header { padding: 20px; border-bottom: 1px solid #e1e1e1; background: #f8f9fa; border-radius: 8px 8px 0 0; min-height: 80px; display: flex; align-items: center; }
        .selected-chat-info h3 { margin: 0 0 5px 0; color: #333; }
        .selected-chat-info p { margin: 0; color: #666; font-size: 14px; }
        .admin-chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #f8f9fa; }
        .admin-message { max-width: 70%; padding: 12px 16px; border-radius: 15px; position: relative; animation: fadeIn 0.3s ease-out; line-height: 1.4; }
        .admin-message.user { align-self: flex-start; background: white; color: #333; border: 1px solid #e1e1e1; border-bottom-left-radius: 5px; }
        .admin-message.agent { align-self: flex-end; background: #007aff; color: white; border-bottom-right-radius: 5px; }
        .admin-message-time { font-size: 11px; opacity: 0.7; margin-top: 5px; }
        .admin-message.user .admin-message-time { text-align: left; }
        .admin-message.agent .admin-message-time { text-align: right; }
        .admin-chat-input-container { padding: 20px; border-top: 1px solid #e1e1e1; }
        .admin-chat-input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
        .admin-chat-input { flex: 1; padding: 12px 16px; border: 2px solid #e1e1e1; border-radius: 25px; resize: none; font-size: 14px; transition: border-color 0.3s; max-height: 120px; min-height: 50px; font-family: inherit; }
        .admin-chat-input:focus { border-color: #007aff; outline: none; }
        .admin-send-btn { background: #007aff; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .admin-send-btn:hover { background: #0056cc; transform: scale(1.05); }
        .admin-send-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .no-chat-selected { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; color: #666; text-align: center; padding: 40px; }
        .no-chat-selected i { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        .no-chat-selected h3 { margin: 0 0 10px 0; font-size: 18px; }
        .no-chat-selected p { margin: 0; font-size: 14px; line-height: 1.4; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Стилі для управління розіграшем */
        .giveaway-management { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        .giveaway-preview { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8e44ad 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; position: relative; overflow: hidden; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .giveaway-preview-content { position: relative; z-index: 2; }
        .giveaway-preview-title { font-size: 2rem; font-weight: bold; margin-bottom: 15px; }
        .giveaway-preview-date { font-size: 1.5rem; font-weight: bold; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px; display: inline-block; }
        .giveaway-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .giveaway-control-group { display: flex; flex-direction: column; gap: 10px; }
        .giveaway-control-group label { font-weight: bold; color: #333; display: flex; align-items: center; gap: 8px; }
        .giveaway-date-input { padding: 12px 15px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .giveaway-date-input:focus { border-color: #007aff; outline: none; }
        .image-upload-giveaway { border: 2px dashed #007aff; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f8f9fa; }
        .image-upload-giveaway:hover { background: #e9ecef; border-color: #0056cc; }
        .image-upload-giveaway i { font-size: 48px; color: #007aff; margin-bottom: 10px; }
        .current-banner-info { margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007aff; }
        .current-banner-info h4 { margin: 0 0 8px 0; color: #007aff; }
        .current-banner-info p { margin: 0; color: #666; font-size: 14px; }

        /* Стилі для налаштувань призів */
        .prizes-management { margin-top: 30px; padding-top: 25px; border-top: 2px solid #f0f0f0; }
        .prize-item-control { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e1e1e1; }
        .prize-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .prize-item-control h4 { margin: 0; color: #333; display: flex; align-items: center; gap: 10px; }
        .prize-type-badge { background: #007aff; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; }
        .prize-type-main { background: #ff6b6b; }
        .prize-controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .prize-control-group { display: flex; flex-direction: column; gap: 8px; }
        .prize-control-group label { font-weight: 500; color: #555; font-size: 14px; }
        .prize-input { padding: 10px 12px; border: 2px solid #e1e1e1; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        .prize-input:focus { border-color: #007aff; outline: none; }
        .prize-description { grid-column: 1 / -1; }
        .prize-description textarea { width: 100%; min-height: 80px; resize: vertical; }

        /* Адаптивність для чату */
        @media (max-width: 1024px) {
            .support-chat-layout { grid-template-columns: 1fr; height: auto; }
            .chat-users-list { max-height: 250px; }
            .admin-chat-container { height: 500px; }
            .giveaway-controls { grid-template-columns: 1fr; }
            .prize-controls-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .support-chat-layout { gap: 15px; }
            .admin-message { max-width: 85%; }
            .chat-user-item { padding: 12px 15px; }
            .giveaway-management { padding: 20px; }
            .giveaway-preview { padding: 20px; }
            .giveaway-preview-title { font-size: 1.5rem; }
            .giveaway-preview-date { font-size: 1.2rem; }
        }
        
        @media (max-width: 480px) {
            .admin-message { max-width: 90%; padding: 10px 14px; }
            .admin-chat-messages { padding: 15px; }
            .admin-chat-input-container { padding: 15px; }
            .giveaway-preview { padding: 15px; min-height: 150px; }
        }
    </style>
</head>
<body>
    <div class="products-admin-container">
        <!-- Header -->
        <header class="products-header">
            <div class="header-left">
                <h1>📦 Управління товарами</h1>
                <span class="products-count" id="products-count">0 товарів</span>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="openAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Додати товар
                </button>
                <button class="btn btn-secondary" onclick="exportProducts()">
                    <i class="fas fa-download"></i>
                    Експорт
                </button>
                <button class="btn btn-success" onclick="syncWithMainSite()">
                    <i class="fas fa-sync"></i>
                    Синхронізувати
                </button>
            </div>
        </header>

        <!-- Admin Tabs -->
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="switchAdminTab('products')">Товари</div>
            <div class="admin-tab" onclick="switchAdminTab('users')">Користувачі</div>
            <div class="admin-tab" onclick="switchAdminTab('support-chat')">Чат підтримки</div>
            <div class="admin-tab" onclick="switchAdminTab('giveaway')">Розіграш</div>
        </div>

        <!-- Products Section -->
        <div class="products-section active" id="products-section">
            <!-- Filters -->
            <div class="products-filters">
                <div class="filter-group">
                    <input type="text" id="search-products" placeholder="🔍 Пошук товарів..." oninput="filterProducts()">
                </div>
                <div class="filter-group">
                    <select id="category-filter" onchange="filterProducts()">
                        <option value="">Всі категорії</option>
                        <option value="iphone">iPhone</option>
                        <option value="ipad">iPad</option>
                        <option value="macbook">MacBook</option>
                        <option value="apple-watch">Apple Watch</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="status-filter" onchange="filterProducts()">
                        <option value="">Всі статуси</option>
                        <option value="in-stock">В наявності</option>
                        <option value="out-of-stock">Немає в наявності</option>
                    </select>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="products-grid" id="products-grid">
                <!-- Товари будуть додаватись тут -->
            </div>
        </div>

        <!-- Users Section -->
        <div class="users-section" id="users-section">
            <div class="products-filters">
                <div class="filter-group">
                    <input type="text" id="search-users" placeholder="🔍 Пошук користувачів..." oninput="filterUsers()">
                </div>
                <div class="filter-group">
                    <select id="status-users-filter" onchange="filterUsers()">
                        <option value="">Всі статуси</option>
                        <option value="active">Активні</option>
                        <option value="blocked">Заблоковані</option>
                        <option value="admin">Адміністратори</option>
                    </select>
                </div>
            </div>

            <div class="users-container">
                <table class="users-table" id="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ім'я</th>
                            <th>Email</th>
                            <th>Телефон</th>
                            <th>Пароль</th>
                            <th>Статус</th>
                            <th>Дата реєстрації</th>
                            <th>Дії</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Користувачі будуть додані тут -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Support Chat Section -->
        <div class="support-chat-section" id="support-chat-section">
            <div class="support-chat-layout">
                <div class="chat-users-list" id="chat-users-list">
                    <!-- Список користувачів з активними чатами -->
                </div>
                
                <div class="admin-chat-container">
                    <div class="admin-chat-header" id="admin-chat-header">
                        <div class="no-chat-selected" id="no-chat-selected">
                            <i class="fas fa-comments"></i>
                            <h3>Оберіть чат для перегляду</h3>
                            <p>Виберіть користувача зі списку, щоб переглянути та відповісти на повідомлення</p>
                        </div>
                        <div class="selected-chat-info" id="selected-chat-info" style="display: none;">
                            <h3 id="selected-user-name">Користувач</h3>
                            <p id="selected-user-status">Онлайн</p>
                        </div>
                    </div>
                    
                    <div class="admin-chat-messages" id="admin-chat-messages">
                        <!-- Повідомлення будуть додаватись тут -->
                    </div>
                    
                    <div class="admin-chat-input-container" id="admin-chat-input-container" style="display: none;">
                        <div class="admin-chat-input-wrapper">
                            <textarea 
                                class="admin-chat-input" 
                                id="admin-message-input" 
                                placeholder="Введіть вашу відповідь..."
                                rows="1"
                            ></textarea>
                            <button class="admin-send-btn" id="admin-send-btn" onclick="sendAdminMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Giveaway Management Section -->
        <div class="support-chat-section" id="giveaway-section">
            <div class="giveaway-management">
                <div class="section-header">
                    <h2><i class="fas fa-gift"></i> Управління розіграшем</h2>
                    <p>Налаштування банера розіграшу на головній сторінці</p>
                </div>

                <!-- Preview -->
                <div class="giveaway-preview" id="giveaway-preview">
                    <div class="giveaway-preview-content">
                        <div class="store-logo" id="preview-store-logo">i<span>Market Sell</span></div>
                        <div class="giveaway-preview-title" id="preview-title">🎉 РОЗІГРАШ ВІД iMarket Sell!</div>
                        <p class="giveaway-subtitle" id="preview-subtitle">
                            🎧 Зареєструй акаунт — і вже береш участь у розіграші навушників Apple!<br>
                            📱 Зроби покупку — і отримай шанс виграти новенький iPhone 15 Pro Max!
                        </p>
                        
                        <div class="prize-section" id="preview-prizes">
                            <div class="prize-item">
                                <div class="prize-icon">🎧</div>
                                <div class="prize-name" id="preview-secondary-prize-name">AirPods Pro</div>
                                <div class="prize-condition" id="preview-secondary-prize-condition">За реєстрацію</div>
                            </div>
                            <div class="prize-item main-prize">
                                <div class="prize-icon">📱</div>
                                <div class="prize-name" id="preview-main-prize-name">iPhone 15 Pro Max</div>
                                <div class="prize-condition" id="preview-main-prize-condition">За покупку</div>
                            </div>
                        </div>

                        <div class="giveaway-timer">
                            <div class="timer-title">
                                <i class="fas fa-clock"></i>
                                Розіграш відбудеться
                            </div>
                            <div class="timer-numbers" id="preview-date">27.11.2024</div>
                        </div>

                        <button class="giveaway-cta">
                            <i class="fas fa-ticket-alt"></i>
                            УЧАСТЬ У РОЗІГРАШІ
                        </button>
                        
                        <div class="participants-count">
                            <i class="fas fa-users"></i>
                            Вже беруть участь: <strong id="preview-participants">2,458</strong> осіб
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="giveaway-controls">
                    <div class="giveaway-control-group">
                        <label>
                            <i class="fas fa-calendar-alt"></i>
                            Дата розіграшу:
                        </label>
                        <input type="date" id="giveaway-date" class="giveaway-date-input" onchange="updateGiveawayPreview()">
                    </div>
                    
                    <div class="giveaway-control-group">
                        <label>
                            <i class="fas fa-image"></i>
                            Фон банера:
                        </label>
                        <div class="image-upload-giveaway" onclick="document.getElementById('banner-image').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Натисніть для завантаження фото</p>
                            <small>Рекомендований розмір: 1200x400px</small>
                        </div>
                        <input type="file" id="banner-image" accept="image/*" style="display: none;" onchange="handleBannerUpload(event)">
                    </div>
                </div>

                <!-- Налаштування призів -->
                <div class="prizes-management">
                    <h3><i class="fas fa-trophy"></i> Налаштування призів</h3>
                    
                    <div class="prize-item-control">
                        <div class="prize-item-header">
                            <h4><i class="fas fa-gift"></i> Головний приз</h4>
                            <span class="prize-type-badge prize-type-main">Головний</span>
                        </div>
                        <div class="prize-controls-grid">
                            <div class="prize-control-group">
                                <label>Назва призу:</label>
                                <input type="text" class="prize-input" id="main-prize-name" value="iPhone 15 Pro Max" oninput="updateGiveawayPreview()">
                            </div>
                            <div class="prize-control-group">
                                <label>Умова отримання:</label>
                                <input type="text" class="prize-input" id="main-prize-condition" value="За покупку" oninput="updateGiveawayPreview()">
                            </div>
                            <div class="prize-control-group prize-description">
                                <label>Опис призу:</label>
                                <textarea class="prize-input" id="main-prize-description" oninput="updateGiveawayPreview()">Новенький iPhone 15 Pro Max з найсучаснішими функціями</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="prize-item-control">
                        <div class="prize-item-header">
                            <h4><i class="fas fa-gift"></i> Додатковий приз</h4>
                            <span class="prize-type-badge">Додатковий</span>
                        </div>
                        <div class="prize-controls-grid">
                            <div class="prize-control-group">
                                <label>Назва призу:</label>
                                <input type="text" class="prize-input" id="secondary-prize-name" value="AirPods Pro" oninput="updateGiveawayPreview()">
                            </div>
                            <div class="prize-control-group">
                                <label>Умова отримання:</label>
                                <input type="text" class="prize-input" id="secondary-prize-condition" value="За реєстрацію" oninput="updateGiveawayPreview()">
                            </div>
                            <div class="prize-control-group prize-description">
                                <label>Опис призу:</label>
                                <textarea class="prize-input" id="secondary-prize-description" oninput="updateGiveawayPreview()">Навушники AirPods Pro з функцією активного шумозаглушення</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Додаткові налаштування -->
                <div class="giveaway-controls">
                    <div class="giveaway-control-group">
                        <label>
                            <i class="fas fa-users"></i>
                            Кількість учасників:
                        </label>
                        <input type="number" id="participants-count" class="giveaway-date-input" value="2458" min="0" oninput="updateGiveawayPreview()">
                    </div>
                    
                    <div class="giveaway-control-group">
                        <label>
                            <i class="fas fa-store"></i>
                            Назва магазину:
                        </label>
                        <input type="text" id="store-name" class="giveaway-date-input" value="iMarket Sell" oninput="updateGiveawayPreview()">
                    </div>
                </div>

                <!-- Current Banner Info -->
                <div class="current-banner-info">
                    <h4>Поточна інформація:</h4>
                    <p id="current-banner-info">Фон: стандартний градієнт | Дата: 27.11.2024 | Учасників: 2,458</p>
                </div>

                <!-- Save Button -->
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveGiveawaySettings()">
                        <i class="fas fa-save"></i>
                        Зберегти налаштування
                    </button>
                    <button class="btn btn-secondary" onclick="resetGiveawaySettings()">
                        <i class="fas fa-undo"></i>
                        Скинути
                    </button>
                    <button class="btn btn-success" onclick="testGiveawaySync()">
                        <i class="fas fa-sync"></i>
                        Тест синхронізації
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Product Modal -->
        <div class="modal" id="product-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-title">Додати товар</h2>
                    <button class="close-btn" onclick="closeProductModal()">&times;</button>
                </div>
                
                <form id="product-form" onsubmit="saveProduct(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-name">Назва товару *</label>
                            <input type="text" id="product-name" required>
                        </div>
                        <div class="form-group">
                            <label for="product-model">Модель *</label>
                            <input type="text" id="product-model" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-category">Категорія *</label>
                            <select id="product-category" required>
                                <option value="">Оберіть категорію</option>
                                <option value="iphone">iPhone</option>
                                <option value="ipad">iPad</option>
                                <option value="macbook">MacBook</option>
                                <option value="apple-watch">Apple Watch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="product-price">Ціна (₴) *</label>
                            <input type="number" id="product-price" min="0" step="1" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="product-specs">Характеристики</label>
                        <input type="text" id="product-specs" placeholder="Наприклад: 6.1'' Super Retina XDR">
                    </div>

                    <div class="form-group">
                        <label for="product-description">Опис</label>
                        <textarea id="product-description" rows="3" placeholder="Детальний опис товару..."></textarea>
                    </div>

                    <!-- Image Upload -->
                    <div class="form-group">
                        <label>Зображення товару</label>
                        <div class="image-upload-container">
                            <div class="image-previews" id="image-previews">
                                <div class="image-preview-placeholder">
                                    <i class="fas fa-images"></i>
                                    <span>Додайте фото товару</span>
                                </div>
                            </div>
                            <div class="upload-controls">
                                <input type="file" id="product-images" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('product-images').click()">
                                    <i class="fas fa-plus"></i>
                                    Додати фото
                                </button>
                                <button type="button" class="btn btn-outline" onclick="clearAllImages()">
                                    <i class="fas fa-trash"></i>
                                    Видалити всі
                                </button>
                            </div>
                            <div class="upload-info">
                                <small>Можна завантажити до 5 фото. Перше фото буде основним.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Characteristics -->
                    <div class="form-group">
                        <label>Додаткові характеристики</label>
                        <div id="characteristics-container">
                            <!-- Characteristics will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline" onclick="addCharacteristic()">
                            <i class="fas fa-plus"></i>
                            Додати характеристику
                        </button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Скасувати</button>
                        <button type="submit" class="btn btn-primary" id="save-product-btn">Зберегти товар</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal" id="delete-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Видалити товар</h2>
                </div>
                <p>Ви впевнені, що хочете видалити цей товар? Цю дію неможливо скасувати.</p>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Скасувати</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Видалити</button>
                </div>
            </div>
        </div>

        <!-- User History Modal -->
        <div class="modal" id="user-history-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Історія замовлень користувача</h2>
                    <button class="close-btn" onclick="closeUserHistoryModal()">&times;</button>
                </div>
                <div class="user-history-content" id="user-history-content">
                    <!-- Історія замовлень буде додана тут -->
                </div>
            </div>
        </div>
    </div>

    <!-- ПОДКЛЮЧЕНИЕ SUPABASE -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // ==== ВАШИ КЛЮЧИ SUPABASE ====
        const supabaseUrl = 'https://mkyeotrxjswptzytnpgi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1reWVvdHJ4anN3cHR6eXRucGdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NDY0NzEsImV4cCI6MjA3NzQyMjQ3MX0.WGj4n2CdAVmLaX77fP-yoLgesS3P1zC9wj3YqM73QXY';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Глобальні змінні
        let products = [];
        let currentEditingId = null;
        let productToDelete = null;
        let productImages = [];
        let currentEditingUser = null;
        let currentChatUser = null;
        let supportChatInterval = null;
        let currentBannerImage = null;
        let passwordVisibility = {};

        // Broadcast Channel для синхронізації
        const broadcastChannel = new BroadcastChannel('products_updates');
        const supportChannel = new BroadcastChannel('support_messages');
        const giveawayChannel = new BroadcastChannel('giveaway_updates');

        // Ініціалізація
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Ініціалізація адмінки з Supabase...');
            loadProducts();
            loadUsers();
            loadSupportChats();
            loadGiveawaySettings();
            setupBroadcastListener();
            autoSyncOnLoad();
            startSupportPolling();
            initializeChatFields();
        });

        // ========== ОСНОВНЫЕ ФУНКЦИИ ДЛЯ SUPABASE ==========

        // Загрузка товаров из Supabase
        async function loadProducts() {
            try {
                showNotification('🔄 Завантаження товарів...', 'info');
                
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Ошибка загрузки товаров:', error);
                    showNotification('❌ Помилка завантаження товарів', 'error');
                    return;
                }

                products = data || [];
                displayProducts(products);
                updateProductsCount();
                
                showNotification(`✅ Завантажено ${products.length} товарів`, 'success');
                
            } catch (error) {
                console.error('Ошибка:', error);
                showNotification('❌ Помилка завантаження товарів', 'error');
            }
        }

        // Сохранение товара в Supabase
        async function saveProduct(event) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('save-product-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Збереження...';

            try {
                const formData = {
                    name: document.getElementById('product-name').value,
                    model: document.getElementById('product-model').value,
                    category: document.getElementById('product-category').value,
                    price: parseInt(document.getElementById('product-price').value),
                    specs: document.getElementById('product-specs').value,
                    description: document.getElementById('product-description').value,
                    status: 'in-stock',
                    images: productImages.map(img => img.data),
                    main_image: productImages.find(img => img.isMain)?.data || productImages[0]?.data || '',
                    characteristics: getCharacteristicsData(),
                    created_at: new Date().toISOString(),
                    last_updated: Date.now()
                };

                let result;
                if (currentEditingId) {
                    // Обновление товара
                    const { data, error } = await supabase
                        .from('products')
                        .update(formData)
                        .eq('id', currentEditingId)
                        .select();

                    if (error) throw error;
                    result = data;
                } else {
                    // Добавление нового товара
                    const { data, error } = await supabase
                        .from('products')
                        .insert([formData])
                        .select();

                    if (error) throw error;
                    result = data;
                }

                showNotification(currentEditingId ? '✅ Товар оновлено!' : '✅ Товар додано!', 'success');
                closeProductModal();
                loadProducts(); // Перезагружаем список
                
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                showNotification('❌ Помилка збереження товару', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Зберегти товар';
            }
        }

        // Удаление товара из Supabase
        async function confirmDelete() {
            if (!productToDelete) return;

            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productToDelete);

                if (error) throw error;

                showNotification('✅ Товар видалено!', 'success');
                closeDeleteModal();
                loadProducts(); // Перезагружаем список
                
            } catch (error) {
                console.error('Ошибка удаления:', error);
                showNotification('❌ Помилка видалення товару', 'error');
            }
        }

        // Получение данных характеристик
        function getCharacteristicsData() {
            const characteristics = {};
            const characteristicRows = document.querySelectorAll('.characteristic-row');
            
            characteristicRows.forEach(row => {
                const keyInput = row.querySelector('input[name^="characteristic-key"]');
                const valueInput = row.querySelector('input[name^="characteristic-value"]');
                
                if (keyInput.value && valueInput.value) {
                    characteristics[keyInput.value] = valueInput.value;
                }
            });
            
            return Object.keys(characteristics).length > 0 ? characteristics : null;
        }

        // ========== ОСТАЛЬНЫЕ ФУНКЦИИ (без изменений) ==========

        function displayProducts(products) {
            const productsGrid = document.getElementById('products-grid');
            
            if (products.length === 0) {
                productsGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">📦</div>
                        <h3 style="margin-bottom: 10px; color: #333;">Немає товарів</h3>
                        <p style="margin-bottom: 25px; color: #666;">Додайте перший товар до вашого магазину</p>
                        <button class="btn btn-primary" onclick="openAddProductModal()">
                            <i class="fas fa-plus"></i>
                            Додати товар
                        </button>
                    </div>
                `;
                return;
            }

            productsGrid.innerHTML = products.map(product => `
                <div class="product-card" data-category="${product.category}" data-status="${product.status || 'in-stock'}">
                    <div class="product-image">
                        ${product.main_image || product.images?.[0] ? 
                            `<img src="${product.main_image || product.images[0]}" alt="${product.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"> 
                             <div class="placeholder" style="display: none;"><i class="fas fa-image"></i></div>` :
                            `<div class="placeholder"><i class="fas fa-image"></i></div>`
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-model">${product.model}</div>
                        <h3>${product.name}</h3>
                        <div class="product-specs">${product.specs || ''}</div>
                        <div class="product-price">${formatPrice(product.price)} ₴</div>
                        <div class="product-status" style="font-size: 12px; color: ${product.status === 'out-of-stock' ? '#e53935' : '#4CAF50'}; margin-bottom: 10px;">
                            ${product.status === 'out-of-stock' ? '❌ Немає в наявності' : '✅ В наявності'}
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-outline" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                                Редагувати
                            </button>
                            <button class="btn btn-danger" onclick="openDeleteModal(${product.id})">
                                <i class="fas fa-trash"></i>
                                Видалити
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatPrice(price) {
            return parseInt(price).toLocaleString('uk-UA');
        }

        function updateProductsCount() {
            const countElement = document.getElementById('products-count');
            countElement.textContent = `${products.length} товар${products.length % 10 === 1 ? '' : 'и'}`;
        }

        function filterProducts() {
            const searchTerm = document.getElementById('search-products').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            
            const productCards = document.querySelectorAll('.product-card');
            
            productCards.forEach(card => {
                const productName = card.querySelector('h3').textContent.toLowerCase();
                const productCategory = card.getAttribute('data-category');
                const productStatus = card.getAttribute('data-status');
                
                const matchesSearch = productName.includes(searchTerm);
                const matchesCategory = !categoryFilter || productCategory === categoryFilter;
                const matchesStatus = !statusFilter || productStatus === statusFilter;
                
                card.style.display = (matchesSearch && matchesCategory && matchesStatus) ? 'block' : 'none';
            });
        }

        function openAddProductModal() {
            currentEditingId = null;
            productImages = [];
            document.getElementById('modal-title').textContent = 'Додати товар';
            document.getElementById('product-form').reset();
            updateImagePreviews();
            document.getElementById('characteristics-container').innerHTML = '';
            document.getElementById('product-modal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
        }

        function handleImageUpload(event) {
            const files = event.target.files;
            const previewsContainer = document.getElementById('image-previews');
            
            const placeholder = previewsContainer.querySelector('.image-preview-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
            
            for (let i = 0; i < files.length; i++) {
                if (productImages.length >= 5) {
                    alert('Максимально можна завантажити 5 фото');
                    break;
                }
                
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const imageData = {
                        id: Date.now() + i,
                        data: e.target.result,
                        isMain: productImages.length === 0
                    };
                    
                    productImages.push(imageData);
                    updateImagePreviews();
                };
                
                reader.readAsDataURL(file);
            }
            
            event.target.value = '';
        }

        function updateImagePreviews() {
            const previewsContainer = document.getElementById('image-previews');
            previewsContainer.innerHTML = '';
            
            if (productImages.length === 0) {
                previewsContainer.innerHTML = `
                    <div class="image-preview-placeholder">
                        <i class="fas fa-images"></i>
                        <span>Додайте фото товару</span>
                    </div>
                `;
                return;
            }
            
            productImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = `image-preview-item ${image.isMain ? 'main-image' : ''}`;
                previewItem.innerHTML = `
                    <img src="${image.data}" alt="Preview ${index + 1}">
                    ${image.isMain ? '<div class="main-badge">Головне</div>' : ''}
                    <div class="image-actions">
                        <button class="image-action-btn" onclick="setAsMainImage(${image.id})" title="Зробити головним">
                            <i class="fas fa-star"></i>
                        </button>
                        <button class="image-action-btn" onclick="removeImage(${image.id})" title="Видалити">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                previewsContainer.appendChild(previewItem);
            });
        }

        function setAsMainImage(imageId) {
            productImages.forEach(image => {
                image.isMain = image.id === imageId;
            });
            updateImagePreviews();
        }

        function removeImage(imageId) {
            const imageIndex = productImages.findIndex(img => img.id === imageId);
            const isMain = productImages[imageIndex].isMain;
            
            productImages.splice(imageIndex, 1);
            
            if (isMain && productImages.length > 0) {
                productImages[0].isMain = true;
            }
            
            updateImagePreviews();
        }

        function clearAllImages() {
            productImages = [];
            updateImagePreviews();
        }

        function addCharacteristic() {
            const container = document.getElementById('characteristics-container');
            const index = container.children.length;
            
            const characteristicRow = document.createElement('div');
            characteristicRow.className = 'characteristic-row';
            characteristicRow.innerHTML = `
                <input type="text" placeholder="Назва характеристики (напр. Процесор)" name="characteristic-key-${index}">
                <input type="text" placeholder="Значення (напр. A15 Bionic)" name="characteristic-value-${index}">
                <button type="button" class="remove-characteristic" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(characteristicRow);
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            currentEditingId = productId;
            document.getElementById('modal-title').textContent = 'Редагувати товар';
            
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-model').value = product.model;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-specs').value = product.specs || '';
            document.getElementById('product-description').value = product.description || '';
            
            productImages = [];
            if (product.images && product.images.length > 0) {
                product.images.forEach((imageData, index) => {
                    productImages.push({
                        id: Date.now() + index,
                        data: imageData,
                        isMain: imageData === product.main_image || index === 0
                    });
                });
            }
            updateImagePreviews();
            
            const container = document.getElementById('characteristics-container');
            container.innerHTML = '';
            
            if (product.characteristics) {
                Object.entries(product.characteristics).forEach(([key, value], index) => {
                    const characteristicRow = document.createElement('div');
                    characteristicRow.className = 'characteristic-row';
                    characteristicRow.innerHTML = `
                        <input type="text" placeholder="Назва характеристики" name="characteristic-key-${index}" value="${key}">
                        <input type="text" placeholder="Значення" name="characteristic-value-${index}" value="${value}">
                        <button type="button" class="remove-characteristic" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(characteristicRow);
                });
            }
            
            document.getElementById('product-modal').classList.add('active');
        }

        function openDeleteModal(productId) {
            productToDelete = productId;
            document.getElementById('delete-modal').classList.add('active');
        }

        function closeDeleteModal() {
            productToDelete = null;
            document.getElementById('delete-modal').classList.remove('active');
        }

        function exportProducts() {
            if (products.length === 0) {
                showNotification('❌ Немає товарів для експорту!', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(products, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `istore-products-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('📦 Товари експортовано успішно!', 'success');
        }

        function syncWithMainSite() {
            localStorage.setItem('storeProducts', JSON.stringify(products));
            localStorage.setItem('productsLastUpdate', Date.now().toString());
            
            broadcastChannel.postMessage({
                type: 'products_updated',
                timestamp: Date.now(),
                count: products.length
            });
            
            showNotification('✅ Синхронізація виконана!', 'success');
        }

        function autoSyncOnLoad() {
            const adminProducts = JSON.parse(localStorage.getItem('adminProducts')) || [];
            const storeProducts = JSON.parse(localStorage.getItem('storeProducts')) || [];
            
            if (adminProducts.length > 0 && storeProducts.length === 0) {
                syncWithMainSite();
            }
        }

        function setupBroadcastListener() {
            broadcastChannel.onmessage = (event) => {
                if (event.data.type === 'products_updated') {
                    console.log('Отримано оновлення товарів');
                    loadProducts();
                    updateProductsCount();
                }
            };
            
            supportChannel.onmessage = (event) => {
                if (event.data.type === 'messages_updated') {
                    console.log('Отримано оновлення повідомлень підтримки');
                    loadSupportChats();
                    if (currentChatUser) {
                        loadChatMessages(currentChatUser);
                    }
                }
            };

            giveawayChannel.onmessage = (event) => {
                if (event.data.type === 'giveaway_updated') {
                    console.log('Отримано оновлення розіграшу');
                    loadGiveawaySettings();
                }
            };
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.products-section, .users-section, .support-chat-section, .support-chat-section').forEach(s => s.classList.remove('active'));
            
            const tabIndex = {'products': 1, 'users': 2, 'support-chat': 3, 'giveaway': 4}[tab];
            const tabElement = document.querySelector(`.admin-tab:nth-child(${tabIndex})`);
            const sectionElement = document.getElementById(`${tab}-section`);
            
            if (tabElement) tabElement.classList.add('active');
            if (sectionElement) sectionElement.classList.add('active');

            if (tab === 'giveaway') {
                updateGiveawayPreview();
            }
        }

        // ========== ФУНКЦІЇ ДЛЯ РОЗІГРАШУ ==========

        function loadGiveawaySettings() {
            const giveawaySettings = JSON.parse(localStorage.getItem('giveawaySettings')) || {};
            
            if (giveawaySettings.date) {
                document.getElementById('giveaway-date').value = giveawaySettings.date;
            } else {
                const defaultDate = new Date();
                defaultDate.setDate(defaultDate.getDate() + 30);
                document.getElementById('giveaway-date').value = defaultDate.toISOString().split('T')[0];
            }
            
            if (giveawaySettings.storeName) {
                document.getElementById('store-name').value = giveawaySettings.storeName;
            }
            if (giveawaySettings.participants) {
                document.getElementById('participants-count').value = giveawaySettings.participants;
            }
            if (giveawaySettings.mainPrize) {
                document.getElementById('main-prize-name').value = giveawaySettings.mainPrize.name;
                document.getElementById('main-prize-condition').value = giveawaySettings.mainPrize.condition;
                document.getElementById('main-prize-description').value = giveawaySettings.mainPrize.description;
            }
            if (giveawaySettings.secondaryPrize) {
                document.getElementById('secondary-prize-name').value = giveawaySettings.secondaryPrize.name;
                document.getElementById('secondary-prize-condition').value = giveawaySettings.secondaryPrize.condition;
                document.getElementById('secondary-prize-description').value = giveawaySettings.secondaryPrize.description;
            }
            
            if (giveawaySettings.background) {
                currentBannerImage = giveawaySettings.background;
                document.getElementById('giveaway-preview').style.backgroundImage = `url(${giveawaySettings.background})`;
                document.getElementById('giveaway-preview').style.backgroundSize = 'cover';
                document.getElementById('giveaway-preview').style.backgroundPosition = 'center';
            }
            
            updateGiveawayPreview();
            updateCurrentBannerInfo();
        }

        function updateGiveawayPreview() {
            const dateInput = document.getElementById('giveaway-date');
            const previewDate = document.getElementById('preview-date');
            
            if (dateInput.value) {
                const date = new Date(dateInput.value);
                const formattedDate = date.toLocaleDateString('uk-UA');
                previewDate.textContent = formattedDate;
            }
            
            const storeName = document.getElementById('store-name').value;
            document.getElementById('preview-store-logo').innerHTML = `i<span>${storeName}</span>`;
            
            const mainPrizeName = document.getElementById('main-prize-name').value;
            const mainPrizeCondition = document.getElementById('main-prize-condition').value;
            const secondaryPrizeName = document.getElementById('secondary-prize-name').value;
            const secondaryPrizeCondition = document.getElementById('secondary-prize-condition').value;
            
            document.getElementById('preview-main-prize-name').textContent = mainPrizeName;
            document.getElementById('preview-main-prize-condition').textContent = mainPrizeCondition;
            document.getElementById('preview-secondary-prize-name').textContent = secondaryPrizeName;
            document.getElementById('preview-secondary-prize-condition').textContent = secondaryPrizeCondition;
            
            const participants = document.getElementById('participants-count').value;
            document.getElementById('preview-participants').textContent = parseInt(participants).toLocaleString('uk-UA');
            
            updateCurrentBannerInfo();
        }

        function handleBannerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentBannerImage = e.target.result;
                document.getElementById('giveaway-preview').style.backgroundImage = `url(${e.target.result})`;
                document.getElementById('giveaway-preview').style.backgroundSize = 'cover';
                document.getElementById('giveaway-preview').style.backgroundPosition = 'center';
                updateCurrentBannerInfo();
            };
            reader.readAsDataURL(file);
        }

        function updateCurrentBannerInfo() {
            const dateInput = document.getElementById('giveaway-date');
            const participants = document.getElementById('participants-count').value;
            
            const date = dateInput.value ? new Date(dateInput.value).toLocaleDateString('uk-UA') : 'Не встановлено';
            const bannerInfo = currentBannerImage ? 'Завантажене фото' : 'Стандартний градієнт';
            
            document.getElementById('current-banner-info').textContent = `Фон: ${bannerInfo} | Дата: ${date} | Учасників: ${parseInt(participants).toLocaleString('uk-UA')}`;
        }

        function saveGiveawaySettings() {
            const dateInput = document.getElementById('giveaway-date').value;
            
            if (!dateInput) {
                showNotification('❌ Будь ласка, встановіть дату розіграшу', 'error');
                return;
            }
            
            const giveawaySettings = {
                date: dateInput,
                storeName: document.getElementById('store-name').value,
                participants: document.getElementById('participants-count').value,
                mainPrize: {
                    name: document.getElementById('main-prize-name').value,
                    condition: document.getElementById('main-prize-condition').value,
                    description: document.getElementById('main-prize-description').value
                },
                secondaryPrize: {
                    name: document.getElementById('secondary-prize-name').value,
                    condition: document.getElementById('secondary-prize-condition').value,
                    description: document.getElementById('secondary-prize-description').value
                },
                background: currentBannerImage,
                lastUpdated: Date.now()
            };
            
            localStorage.setItem('giveawaySettings', JSON.stringify(giveawaySettings));
            
            broadcastGiveawayUpdate();
            
            showNotification('✅ Налаштування розіграшу збережено!', 'success');
        }

        function broadcastGiveawayUpdate() {
            localStorage.setItem('giveawayLastUpdate', Date.now().toString());
            
            if (typeof BroadcastChannel !== 'undefined') {
                giveawayChannel.postMessage({
                    type: 'giveaway_updated',
                    timestamp: Date.now(),
                    data: JSON.parse(localStorage.getItem('giveawaySettings'))
                });
            }
            
            localStorage.setItem('mainPageGiveawayData', localStorage.getItem('giveawaySettings'));
        }

        function resetGiveawaySettings() {
            if (confirm('Ви впевнені, що хочете скинути всі налаштування розіграшу?')) {
                document.getElementById('giveaway-date').value = '';
                document.getElementById('store-name').value = 'iMarket Sell';
                document.getElementById('participants-count').value = '2458';
                document.getElementById('main-prize-name').value = 'iPhone 15 Pro Max';
                document.getElementById('main-prize-condition').value = 'За покупку';
                document.getElementById('main-prize-description').value = 'Новенький iPhone 15 Pro Max з найсучаснішими функціями';
                document.getElementById('secondary-prize-name').value = 'AirPods Pro';
                document.getElementById('secondary-prize-condition').value = 'За реєстрацію';
                document.getElementById('secondary-prize-description').value = 'Навушники AirPods Pro з функцією активного шумозаглушення';
                
                currentBannerImage = null;
                const preview = document.getElementById('giveaway-preview');
                preview.style.backgroundImage = '';
                preview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8e44ad 100%)';
                
                updateGiveawayPreview();
                
                showNotification('⚙️ Налаштування скинуто до значень за замовчуванням', 'info');
            }
        }

        function testGiveawaySync() {
            const giveawayData = localStorage.getItem('giveawaySettings');
            if (giveawayData) {
                const settings = JSON.parse(giveawayData);
                console.log('Тест синхронізації:', settings);
                showNotification('🔍 Дані успішно синхронізовані! Перевірте консоль для деталей.', 'success');
            } else {
                showNotification('❌ Немає даних для синхронізації', 'error');
            }
        }

        // ========== СИСТЕМА ЧАТУ ПІДТРИМКИ ==========

        function initializeChatFields() {
            const adminMessageInput = document.getElementById('admin-message-input');
            if (adminMessageInput) {
                adminMessageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });

                adminMessageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendAdminMessage();
                    }
                });
            }
        }

        function loadSupportChats() {
            const chatUsersList = document.getElementById('chat-users-list');
            const allMessages = getAllSupportMessages();
            
            const uniqueUsers = {};
            allMessages.forEach(msg => {
                if (!uniqueUsers[msg.userId]) {
                    uniqueUsers[msg.userId] = {
                        userId: msg.userId,
                        lastMessage: msg.text,
                        lastMessageTime: msg.timestamp,
                        unread: countUnreadMessages(msg.userId)
                    };
                } else {
                    if (new Date(msg.timestamp) > new Date(uniqueUsers[msg.userId].lastMessageTime)) {
                        uniqueUsers[msg.userId].lastMessage = msg.text;
                        uniqueUsers[msg.userId].lastMessageTime = msg.timestamp;
                    }
                }
            });
            
            const usersArray = Object.values(uniqueUsers);
            
            if (usersArray.length === 0) {
                chatUsersList.innerHTML = `
                    <div class="empty-users">
                        <i class="fas fa-comments"></i>
                        <h3>Чатів немає</h3>
                        <p>Користувачі ще не зверталися до підтримки</p>
                    </div>
                `;
                return;
            }
            
            usersArray.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            
            chatUsersList.innerHTML = usersArray.map(user => `
                <div class="chat-user-item ${currentChatUser === user.userId ? 'active' : ''}" onclick="selectChatUser('${user.userId}')">
                    <div class="chat-user-info">
                        <div class="chat-user-name">Користувач ${user.userId.substring(5)}</div>
                        <div class="chat-user-last-message">${user.lastMessage.length > 50 ? user.lastMessage.substring(0, 50) + '...' : user.lastMessage}</div>
                    </div>
                    <div class="chat-user-meta">
                        <div class="chat-user-time">${formatMessageTime(user.lastMessageTime)}</div>
                        ${user.unread > 0 ? `<div class="unread-badge">${user.unread}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getAllSupportMessages() {
            return JSON.parse(localStorage.getItem('supportMessages')) || [];
        }

        function getUserSupportMessages(userId) {
            const allMessages = getAllSupportMessages();
            return allMessages.filter(msg => msg.userId === userId);
        }

        function countUnreadMessages(userId) {
            const userMessages = getUserSupportMessages(userId);
            return userMessages.filter(msg => msg.type === 'user' && !msg.read).length;
        }

        function selectChatUser(userId) {
            currentChatUser = userId;
            loadSupportChats();
            loadChatMessages(userId);
            markMessagesAsRead(userId);
        }

        function loadChatMessages(userId) {
            const adminChatMessages = document.getElementById('admin-chat-messages');
            const userMessages = getUserSupportMessages(userId);
            
            adminChatMessages.innerHTML = '';
            
            userMessages.forEach(msg => {
                addAdminMessageToChat(msg.text, msg.type, msg.timestamp, false);
            });
            
            adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
            
            document.getElementById('no-chat-selected').style.display = 'none';
            document.getElementById('selected-chat-info').style.display = 'block';
            document.getElementById('admin-chat-input-container').style.display = 'block';
            
            document.getElementById('selected-user-name').textContent = `Користувач ${userId.substring(5)}`;
        }

        function addAdminMessageToChat(text, sender, timestamp, animate = true) {
            const adminChatMessages = document.getElementById('admin-chat-messages');
            const messageDiv = document.createElement('div');
            
            const messageTime = new Date(timestamp);
            const timeString = messageTime.getHours().toString().padStart(2, '0') + ':' + 
                             messageTime.getMinutes().toString().padStart(2, '0');
            
            messageDiv.className = `admin-message ${sender}`;
            if (animate) {
                messageDiv.style.animation = 'fadeIn 0.3s ease-out';
            }
            
            messageDiv.innerHTML = `
                <div class="admin-message-text">${text}</div>
                <div class="admin-message-time">${timeString}</div>
            `;
            
            adminChatMessages.appendChild(messageDiv);
            adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
        }

        function sendAdminMessage() {
            if (!currentChatUser) {
                showNotification('Оберіть користувача для відповіді', 'error');
                return;
            }
            
            const messageInput = document.getElementById('admin-message-input');
            const messageText = messageInput.value.trim();
            
            if (messageText === '') {
                showNotification('Будь ласка, введіть повідомлення', 'error');
                return;
            }
            
            const message = {
                id: 'msg_' + Date.now(),
                userId: currentChatUser,
                text: messageText,
                type: 'agent',
                timestamp: new Date().toISOString(),
                read: true
            };
            
            saveSupportMessage(message);
            addAdminMessageToChat(messageText, 'agent', message.timestamp, true);
            
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            broadcastSupportUpdate();
            
            showNotification('Повідомлення відправлено', 'success');
        }

        function saveSupportMessage(message) {
            const allMessages = getAllSupportMessages();
            allMessages.push(message);
            localStorage.setItem('supportMessages', JSON.stringify(allMessages));
        }

        function markMessagesAsRead(userId) {
            const allMessages = getAllSupportMessages();
            let updated = false;
            
            allMessages.forEach(msg => {
                if (msg.userId === userId && msg.type === 'user' && !msg.read) {
                    msg.read = true;
                    updated = true;
                }
            });
            
            if (updated) {
                localStorage.setItem('supportMessages', JSON.stringify(allMessages));
                loadSupportChats();
            }
        }

        function formatMessageTime(timestamp) {
            const messageTime = new Date(timestamp);
            const now = new Date();
            const diffMs = now - messageTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'щойно';
            if (diffMins < 60) return `${diffMins} хв`;
            if (diffHours < 24) return `${diffHours} год`;
            if (diffDays < 7) return `${diffDays} дн`;
            
            return messageTime.toLocaleDateString('uk-UA');
        }

        function broadcastSupportUpdate() {
            localStorage.setItem('supportLastUpdate', Date.now().toString());
            
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('support_messages');
                channel.postMessage({
                    type: 'messages_updated',
                    timestamp: Date.now()
                });
            }
        }

        function startSupportPolling() {
            supportChatInterval = setInterval(() => {
                const lastUpdate = localStorage.getItem('supportLastUpdate');
                const currentUpdate = localStorage.getItem('currentAdminSupportUpdate');
                
                if (lastUpdate !== currentUpdate) {
                    loadSupportChats();
                    if (currentChatUser) {
                        loadChatMessages(currentChatUser);
                    }
                    localStorage.setItem('currentAdminSupportUpdate', lastUpdate);
                }
            }, 2000);
        }

        // ========== УПРАВЛІННЯ КОРИСТУВАЧАМИ ==========

        function loadUsers() {
            const usersTableBody = document.getElementById('users-table-body');
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            
            if (usersDatabase.length === 0) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-users">
                            <i class="fas fa-users"></i>
                            <h3>Користувачів не знайдено</h3>
                            <p>Користувачі з'являться після реєстрації на сайті</p>
                        </td>
                    </tr>
                `;
                return;
            }

            usersTableBody.innerHTML = usersDatabase.map(user => {
                const isPasswordVisible = passwordVisibility[user.id] || false;
                const passwordDisplay = isPasswordVisible ? user.password : '••••••••';
                
                return `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || 'Не вказано'}</td>
                    <td>${passwordDisplay}</td>
                    <td>
                        <span class="user-status ${getUserStatusClass(user)}">
                            ${getUserStatusText(user)}
                        </span>
                    </td>
                    <td>${new Date(user.createdAt).toLocaleDateString('uk-UA')}</td>
                    <td class="user-actions">
                        ${user.isBlocked ? 
                            `<button class="user-btn unblock" onclick="toggleUserBlock(${user.id})">
                                <i class="fas fa-unlock"></i> Розблокувати
                            </button>` :
                            `<button class="user-btn block" onclick="toggleUserBlock(${user.id})">
                                <i class="fas fa-ban"></i> Заблокувати
                            </button>`
                        }
                        ${!user.isAdmin ? 
                            `<button class="user-btn admin" onclick="toggleAdminStatus(${user.id})">
                                <i class="fas fa-crown"></i> Зробити адміном
                            </button>` :
                            `<button class="user-btn admin" onclick="toggleAdminStatus(${user.id})" style="background: #6c757d;">
                                <i class="fas fa-user"></i> Забрати права
                            </button>`
                        }
                        <button class="user-btn password" onclick="togglePasswordVisibility(${user.id})">
                            <i class="fas ${isPasswordVisible ? 'fa-eye-slash' : 'fa-eye'}"></i> 
                            ${isPasswordVisible ? 'Приховати' : 'Показати пароль'}
                        </button>
                        <button class="user-btn history" onclick="showUserHistory(${user.id})">
                            <i class="fas fa-history"></i> Історія
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function togglePasswordVisibility(userId) {
            passwordVisibility[userId] = !passwordVisibility[userId];
            loadUsers();
        }

        function getUserStatusClass(user) {
            if (user.isBlocked) return 'status-blocked';
            if (user.isAdmin) return 'status-admin';
            return 'status-active';
        }

        function getUserStatusText(user) {
            if (user.isBlocked) return 'Заблокований';
            if (user.isAdmin) return 'Адміністратор';
            return 'Активний';
        }

        function toggleUserBlock(userId) {
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            const userIndex = usersDatabase.findIndex(u => u.id === userId);
            
            if (userIndex !== -1) {
                usersDatabase[userIndex].isBlocked = !usersDatabase[userIndex].isBlocked;
                localStorage.setItem('storeUsers', JSON.stringify(usersDatabase));
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser && currentUser.id === userId) {
                    currentUser.isBlocked = usersDatabase[userIndex].isBlocked;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                loadUsers();
                showNotification(usersDatabase[userIndex].isBlocked ? 
                    '✅ Користувача заблоковано' : '✅ Користувача розблоковано', 'success');
            }
        }

        function toggleAdminStatus(userId) {
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            const userIndex = usersDatabase.findIndex(u => u.id === userId);
            
            if (userIndex !== -1) {
                usersDatabase[userIndex].isAdmin = !usersDatabase[userIndex].isAdmin;
                localStorage.setItem('storeUsers', JSON.stringify(usersDatabase));
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser && currentUser.id === userId) {
                    currentUser.isAdmin = usersDatabase[userIndex].isAdmin;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                loadUsers();
                showNotification(usersDatabase[userIndex].isAdmin ? 
                    '✅ Права адміна надано' : '✅ Права адміна забрано', 'success');
            }
        }

        function showUserHistory(userId) {
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            const user = usersDatabase.find(u => u.id === userId);
            
            if (!user) return;

            const historyContent = document.getElementById('user-history-content');
            const orders = user.orders || [];

            if (orders.length === 0) {
                historyContent.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-shopping-bag" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3>Замовлень немає</h3>
                        <p>Користувач ще не робив замовлень</p>
                    </div>
                `;
            } else {
                historyContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>Користувач: ${user.name}</h3>
                        <p>Email: ${user.email}</p>
                        <p>Всього замовлень: ${orders.length}</p>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${orders.map(order => `
                            <div style="border: 1px solid #e1e1e1; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong>Замовлення #${order.id}</strong>
                                    <span style="color: #e53935; font-weight: bold;">${order.total ? order.total.toLocaleString('uk-UA') + ' ₴' : 'Ціна не вказана'}</span>
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    <div>Дата: ${new Date(order.date).toLocaleDateString('uk-UA')}</div>
                                    <div>Статус: ${order.status === 'completed' ? '✅ Виконано' : '⏳ В обробці'}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            document.getElementById('user-history-modal').classList.add('active');
        }

        function closeUserHistoryModal() {
            document.getElementById('user-history-modal').classList.remove('active');
        }

        function filterUsers() {
            const searchTerm = document.getElementById('search-users').value.toLowerCase();
            const statusFilter = document.getElementById('status-users-filter').value;
            
            const usersTableBody = document.getElementById('users-table-body');
            const usersDatabase = JSON.parse(localStorage.getItem('storeUsers')) || [];
            
            const filteredUsers = usersDatabase.filter(user => {
                const matchesSearch = user.name.toLowerCase().includes(searchTerm) || 
                                    user.email.toLowerCase().includes(searchTerm);
                
                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = !user.isBlocked && !user.isAdmin;
                } else if (statusFilter === 'blocked') {
                    matchesStatus = user.isBlocked;
                } else if (statusFilter === 'admin') {
                    matchesStatus = user.isAdmin;
                }
                
                return matchesSearch && matchesStatus;
            });

            if (filteredUsers.length === 0) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px 20px; color: #666;">
                            <i class="fas fa-search"></i>
                            <p>Користувачів не знайдено</p>
                        </td>
                    </tr>
                `;
                return;
            }

            usersTableBody.innerHTML = filteredUsers.map(user => {
                const isPasswordVisible = passwordVisibility[user.id] || false;
                const passwordDisplay = isPasswordVisible ? user.password : '••••••••';
                
                return `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || 'Не вказано'}</td>
                    <td>${passwordDisplay}</td>
                    <td>
                        <span class="user-status ${getUserStatusClass(user)}">
                            ${getUserStatusText(user)}
                        </span>
                    </td>
                    <td>${new Date(user.createdAt).toLocaleDateString('uk-UA')}</td>
                    <td class="user-actions">
                        ${user.isBlocked ? 
                            `<button class="user-btn unblock" onclick="toggleUserBlock(${user.id})">
                                <i class="fas fa-unlock"></i> Розблокувати
                            </button>` :
                            `<button class="user-btn block" onclick="toggleUserBlock(${user.id})">
                                <i class="fas fa-ban"></i> Заблокувати
                            </button>`
                        }
                        ${!user.isAdmin ? 
                            `<button class="user-btn admin" onclick="toggleAdminStatus(${user.id})">
                                <i class="fas fa-crown"></i> Зробити адміном
                            </button>` :
                            `<button class="user-btn admin" onclick="toggleAdminStatus(${user.id})" style="background: #6c757d;">
                                <i class="fas fa-user"></i> Забрати права
                            </button>`
                        }
                        <button class="user-btn password" onclick="togglePasswordVisibility(${user.id})">
                            <i class="fas ${isPasswordVisible ? 'fa-eye-slash' : 'fa-eye'}"></i> 
                            ${isPasswordVisible ? 'Приховати' : 'Показати пароль'}
                        </button>
                        <button class="user-btn history" onclick="showUserHistory(${user.id})">
                            <i class="fas fa-history"></i> Історія
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#e53935' : '#007aff'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        window.addEventListener('beforeunload', function() {
            if (supportChatInterval) {
                clearInterval(supportChatInterval);
            }
        });

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
